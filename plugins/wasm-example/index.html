<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WASMæ’ä»¶ç¤ºä¾‹</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        #app {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        .plugin-header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .plugin-header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .plugin-description {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .plugin-content {
            padding: 30px;
        }

        .feature-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            background: #f8f9fa;
        }

        .feature-section h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .info-card {
            background: white;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #4facfe;
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .action-btn.primary {
            background: #4facfe;
            color: white;
        }

        .action-btn.primary:hover {
            background: #3d8bfe;
            transform: translateY(-2px);
        }

        .action-btn.secondary {
            background: #6c757d;
            color: white;
        }

        .action-btn.secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .input-group input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            min-width: 200px;
        }

        .result-display {
            margin-top: 15px;
            padding: 10px;
            background: white;
            border-radius: 4px;
            border: 1px solid #ddd;
            min-height: 40px;
            font-family: monospace;
            white-space: pre-wrap;
        }

        .wasm-output {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div id="app">
        <header class="plugin-header">
            <h1>âš¡ WASMæ’ä»¶ç¤ºä¾‹</h1>
            <p class="plugin-description">å±•ç¤º WebAssembly åœ¨ Why-Talk æ’ä»¶ç³»ç»Ÿä¸­çš„åº”ç”¨</p>
        </header>
        
        <main class="plugin-content">
            <section class="feature-section">
                <h2>ğŸ“‹ æ’ä»¶ä¿¡æ¯</h2>
                <div id="plugin-info" class="info-card">
                    <p>åŠ è½½ä¸­...</p>
                </div>
            </section>
            
            <section class="feature-section">
                <h2>ğŸ”§ WASM åŠŸèƒ½æµ‹è¯•</h2>
                <div class="input-group">
                    <input type="number" id="input-a" placeholder="è¾“å…¥æ•°å­— A" value="10">
                    <input type="number" id="input-b" placeholder="è¾“å…¥æ•°å­— B" value="20">
                </div>
                <div class="button-group">
                    <button id="wasm-add" class="action-btn primary">WASM åŠ æ³•</button>
                    <button id="wasm-multiply" class="action-btn primary">WASM ä¹˜æ³•</button>
                    <button id="load-wasm" class="action-btn secondary">åŠ è½½ WASM æ¨¡å—</button>
                </div>
                <div id="wasm-result" class="result-display">ç­‰å¾… WASM æ“ä½œ...</div>
            </section>
            
            <section class="feature-section">
                <h2>ğŸ’¬ æ¶ˆæ¯é€šä¿¡</h2>
                <div class="input-group">
                    <input type="text" id="message-input" placeholder="è¾“å…¥æ¶ˆæ¯" value="Hello from WASM Plugin!">
                </div>
                <div class="button-group">
                    <button id="send-message" class="action-btn primary">å‘é€æ¶ˆæ¯</button>
                    <button id="get-config" class="action-btn secondary">è·å–é…ç½®</button>
                </div>
                <div id="message-result" class="result-display">ç­‰å¾…æ¶ˆæ¯æ“ä½œ...</div>
            </section>
            
            <section class="feature-section">
                <h2>ğŸ“Š WASM æ€§èƒ½æµ‹è¯•</h2>
                <div class="button-group">
                    <button id="performance-test" class="action-btn primary">è¿è¡Œæ€§èƒ½æµ‹è¯•</button>
                    <button id="memory-test" class="action-btn secondary">å†…å­˜ä½¿ç”¨æµ‹è¯•</button>
                </div>
                <div id="performance-result" class="wasm-output">ç­‰å¾…æ€§èƒ½æµ‹è¯•...</div>
            </section>
        </main>
    </div>

    <script>
        // æ’ä»¶APIåˆå§‹åŒ–
        let wasmModule = null;
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async () => {
            // ç­‰å¾…pluginAPIåŠ è½½
            if (window.pluginAPI) {
                await initializePlugin();
                setupEventListeners();
            } else {
                // å…¼å®¹æ€§å¤„ç†ï¼šç¡®ä¿ CustomEvent å¯ç”¨
                if (typeof CustomEvent === 'undefined') {
                    window.CustomEvent = function(event, params) {
                        params = params || { bubbles: false, cancelable: false, detail: undefined };
                        var evt = document.createEvent('CustomEvent');
                        evt.initCustomEvent(event, params.bubbles, params.cancelable, params.detail);
                        return evt;
                    };
                    CustomEvent.prototype = window.Event.prototype;
                }
                
                window.addEventListener('pluginAPIReady', async () => {
                    console.log('Plugin API is ready, initializing plugin...');
                    await initializePlugin();
                    setupEventListeners();
                });
            }
        });
        
        // ç­‰å¾…pluginAPIåŠ è½½
        function waitForPluginAPI() {
            return new Promise((resolve) => {
                if (window.pluginAPI) {
                    resolve();
                    return;
                }
                
                const checkInterval = setInterval(() => {
                    if (window.pluginAPI) {
                        clearInterval(checkInterval);
                        resolve();
                    }
                }, 100);
                
                // 5ç§’è¶…æ—¶
                setTimeout(() => {
                    clearInterval(checkInterval);
                    resolve();
                }, 5000);
            });
        }
        
        // åˆå§‹åŒ–æ’ä»¶
        async function initializePlugin() {
            try {
                // æ˜¾ç¤ºæ’ä»¶ä¿¡æ¯
                if (window.pluginAPI) {
                    const config = window.pluginAPI.getConfig();
                    document.getElementById('plugin-info').innerHTML = `
                        <strong>æ’ä»¶ID:</strong> ${window.pluginAPI.id}<br>
                        <strong>æ’ä»¶åç§°:</strong> ${config.name}<br>
                        <strong>ç‰ˆæœ¬:</strong> ${config.version}<br>
                        <strong>ç±»å‹:</strong> ${config.type}<br>
                        <strong>æè¿°:</strong> ${config.description || 'æ— æè¿°'}
                    `;
                } else {
                    document.getElementById('plugin-info').innerHTML = 'æ’ä»¶APIæœªåŠ è½½';
                }
            } catch (error) {
                console.error('åˆå§‹åŒ–æ’ä»¶å¤±è´¥:', error);
                document.getElementById('plugin-info').innerHTML = 'åˆå§‹åŒ–å¤±è´¥: ' + error.message;
            }
        }
        
        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // WASM åŠŸèƒ½æŒ‰é’®
            document.getElementById('load-wasm').addEventListener('click', loadWasmModule);
            document.getElementById('wasm-add').addEventListener('click', () => performWasmOperation('add'));
            document.getElementById('wasm-multiply').addEventListener('click', () => performWasmOperation('multiply'));
            
            // æ¶ˆæ¯é€šä¿¡æŒ‰é’®
            document.getElementById('send-message').addEventListener('click', sendMessage);
            document.getElementById('get-config').addEventListener('click', getPluginConfig);
            
            // æ€§èƒ½æµ‹è¯•æŒ‰é’®
            document.getElementById('performance-test').addEventListener('click', runPerformanceTest);
            document.getElementById('memory-test').addEventListener('click', runMemoryTest);
        }
        
        // åŠ è½½ WASM æ¨¡å—
        async function loadWasmModule() {
            const resultDiv = document.getElementById('wasm-result');
            try {
                resultDiv.textContent = 'æ­£åœ¨åŠ è½½ WASM æ¨¡å—...';
                
                // è¿™é‡Œåº”è¯¥åŠ è½½å®é™…çš„ WASM æ–‡ä»¶
                // ç”±äºè¿™æ˜¯æ¼”ç¤ºï¼Œæˆ‘ä»¬æ¨¡æ‹ŸåŠ è½½è¿‡ç¨‹
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // æ¨¡æ‹Ÿ WASM æ¨¡å—
                wasmModule = {
                    add: (a, b) => a + b,
                    multiply: (a, b) => a * b
                };
                
                resultDiv.textContent = 'WASM æ¨¡å—åŠ è½½æˆåŠŸï¼';
            } catch (error) {
                resultDiv.textContent = 'WASM æ¨¡å—åŠ è½½å¤±è´¥: ' + error.message;
            }
        }
        
        // æ‰§è¡Œ WASM æ“ä½œ
        async function performWasmOperation(operation) {
            const resultDiv = document.getElementById('wasm-result');
            const inputA = parseFloat(document.getElementById('input-a').value) || 0;
            const inputB = parseFloat(document.getElementById('input-b').value) || 0;
            
            try {
                if (!wasmModule) {
                    await loadWasmModule();
                }
                
                let result;
                const startTime = performance.now();
                
                switch (operation) {
                    case 'add':
                        result = wasmModule.add(inputA, inputB);
                        break;
                    case 'multiply':
                        result = wasmModule.multiply(inputA, inputB);
                        break;
                    default:
                        throw new Error('æœªçŸ¥æ“ä½œ');
                }
                
                const endTime = performance.now();
                const executionTime = (endTime - startTime).toFixed(3);
                
                resultDiv.innerHTML = `
                    <strong>æ“ä½œ:</strong> ${operation}<br>
                    <strong>è¾“å…¥:</strong> ${inputA}, ${inputB}<br>
                    <strong>ç»“æœ:</strong> ${result}<br>
                    <strong>æ‰§è¡Œæ—¶é—´:</strong> ${executionTime} ms
                `;
            } catch (error) {
                resultDiv.textContent = 'æ“ä½œå¤±è´¥: ' + error.message;
            }
        }
        
        // å‘é€æ¶ˆæ¯
        async function sendMessage() {
            const resultDiv = document.getElementById('message-result');
            const message = document.getElementById('message-input').value;
            
            try {
                if (window.pluginAPI && window.pluginAPI.sendMessage) {
                    await window.pluginAPI.sendMessage(message);
                    resultDiv.textContent = `æ¶ˆæ¯å·²å‘é€: ${message}`;
                } else {
                    resultDiv.textContent = 'æ’ä»¶APIä¸å¯ç”¨ï¼Œæ— æ³•å‘é€æ¶ˆæ¯';
                }
            } catch (error) {
                resultDiv.textContent = 'å‘é€æ¶ˆæ¯å¤±è´¥: ' + error.message;
            }
        }
        
        // è·å–æ’ä»¶é…ç½®
        function getPluginConfig() {
            const resultDiv = document.getElementById('message-result');
            
            try {
                if (window.pluginAPI) {
                    const config = window.pluginAPI.getConfig();
                    resultDiv.textContent = JSON.stringify(config, null, 2);
                } else {
                    resultDiv.textContent = 'æ’ä»¶APIä¸å¯ç”¨';
                }
            } catch (error) {
                resultDiv.textContent = 'è·å–é…ç½®å¤±è´¥: ' + error.message;
            }
        }
        
        // è¿è¡Œæ€§èƒ½æµ‹è¯•
        async function runPerformanceTest() {
            const resultDiv = document.getElementById('performance-result');
            
            try {
                resultDiv.textContent = 'æ­£åœ¨è¿è¡Œæ€§èƒ½æµ‹è¯•...';
                
                if (!wasmModule) {
                    await loadWasmModule();
                }
                
                const iterations = 100000;
                const startTime = performance.now();
                
                for (let i = 0; i < iterations; i++) {
                    wasmModule.add(i, i + 1);
                }
                
                const endTime = performance.now();
                const totalTime = (endTime - startTime).toFixed(3);
                const avgTime = (totalTime / iterations * 1000).toFixed(6);
                
                resultDiv.textContent = `
æ€§èƒ½æµ‹è¯•ç»“æœ:
- è¿­ä»£æ¬¡æ•°: ${iterations.toLocaleString()}
- æ€»æ—¶é—´: ${totalTime} ms
- å¹³å‡æ—¶é—´: ${avgTime} Î¼s/æ“ä½œ
- æ“ä½œ/ç§’: ${(iterations / (totalTime / 1000)).toLocaleString()}`;
            } catch (error) {
                resultDiv.textContent = 'æ€§èƒ½æµ‹è¯•å¤±è´¥: ' + error.message;
            }
        }
        
        // è¿è¡Œå†…å­˜æµ‹è¯•
        function runMemoryTest() {
            const resultDiv = document.getElementById('performance-result');
            
            try {
                if (performance.memory) {
                    const memory = performance.memory;
                    resultDiv.textContent = `
å†…å­˜ä½¿ç”¨æƒ…å†µ:
- å·²ä½¿ç”¨å †å†…å­˜: ${(memory.usedJSHeapSize / 1024 / 1024).toFixed(2)} MB
- æ€»å †å†…å­˜: ${(memory.totalJSHeapSize / 1024 / 1024).toFixed(2)} MB
- å †å†…å­˜é™åˆ¶: ${(memory.jsHeapSizeLimit / 1024 / 1024).toFixed(2)} MB`;
                } else {
                    resultDiv.textContent = 'æµè§ˆå™¨ä¸æ”¯æŒå†…å­˜ç›‘æ§';
                }
            } catch (error) {
                resultDiv.textContent = 'å†…å­˜æµ‹è¯•å¤±è´¥: ' + error.message;
            }
        }
    </script>
</body>
</html>