# WhyTalk P2P 多客户端测试指南

## 概述

本指南介绍如何在同一台电脑上启动多个 WhyTalk 客户端实例，以测试 P2P 功能。由于 P2P 网络需要至少两个节点才能进行通信，单个客户端无法完整测试 P2P 功能。

## 为什么需要多客户端测试？

1. **P2P 网络特性**: P2P 网络需要多个节点才能形成网络
2. **节点发现**: 测试 mDNS 节点发现机制是否正常工作
3. **消息传输**: 验证节点间的消息传输功能
4. **连接管理**: 测试节点连接、断开、重连等功能
5. **多用户场景**: 模拟真实的多用户P2P通信环境

## 用户账号管理

### 预配置用户

系统预配置了以下测试用户：

| 客户端 | 用户名 | 手机号 | 密码 | 端口 |
|--------|--------|--------|------|------|
| 客户端1 | Alice | 13800138001 | 123456 | 5173 |
| 客户端2 | Bob | 13800138002 | 123456 | 5174 |
| 客户端3 | Charlie | 13800138003 | 123456 | 5175 |
| 客户端4 | Diana | 13800138004 | 123456 | 5176 |

### 创建用户账号

在启动客户端之前，需要先创建用户账号：

```bash
# 创建所有预配置用户
node create-multiple-users.js
```

这个脚本会：
- 为每个客户端创建独立的用户数据目录
- 在各自的数据库中创建用户账号
- 生成登录配置文件 `multi-user-config.json`

## 测试方法

### 方法1：使用 PowerShell 脚本 (推荐)

```powershell
# 在项目根目录执行
.\Start-MultipleClients.ps1
```

**特点：**
- 自动创建独立的用户数据目录
- 自动分配不同的端口
- 提供详细的启动信息
- 支持自定义客户端数量

**参数：**
```powershell
# 启动 3 个客户端，从端口 5173 开始
.\Start-MultipleClients.ps1 -ClientCount 3 -BasePort 5173
```

### 方法2：使用批处理脚本

```cmd
# 双击运行或在命令行执行
start-multiple-clients.bat
```

**特点：**
- 简单易用
- 固定启动 2 个客户端
- 自动打开新的命令行窗口

### 方法3：手动启动

在不同的命令行终端中执行：

```bash
# 终端 1 - 客户端 1
set ELECTRON_USER_DATA_DIR=%cd%\userData-client-1
npm run dev

# 终端 2 - 客户端 2  
set ELECTRON_USER_DATA_DIR=%cd%\userData-client-2
set VITE_DEV_PORT=5174
npm run dev
```

## 测试步骤

### 1. 启动客户端
- 使用上述任一方法启动多个客户端
- 等待所有客户端完全启动 (约 30-60 秒)

### 2. 访问应用
- 客户端 1: http://localhost:5173
- 客户端 2: http://localhost:5174
- 客户端 3: http://localhost:5175 (如果启动了第3个)

### 3. 登录应用
- 可以使用相同的账号登录所有客户端
- 也可以使用不同的账号进行测试

### 4. 检查 P2P 状态
1. 导航到 **P2P 管理** 页面
2. 检查 P2P 服务状态是否为 "运行中"
3. 查看节点 ID 是否已生成
4. 检查是否能发现其他节点

### 5. 测试 P2P 功能
1. **节点发现**：在 "已发现节点" 列表中查看其他客户端
2. **添加联系人**：将其他节点添加为联系人
3. **发送消息**：测试点对点消息发送
4. **创建群组**：测试群组功能
5. **文件传输**：测试文件分享功能

## 故障排除

### P2P 服务未启动
- 检查终端日志是否有错误信息
- 确认端口没有被占用
- 重启 P2P 服务

### 无法发现其他节点
- 确认所有客户端的 P2P 服务都在运行
- 检查防火墙设置
- 确认在同一网络环境中

### 端口冲突
- 修改 `VITE_DEV_PORT` 环境变量
- 使用不同的端口号启动

## 技术原理

### 用户数据隔离
每个客户端使用独立的用户数据目录：
- `userData-client-1/`
- `userData-client-2/`
- `userData-client-3/`

这确保了：
- 独立的数据库
- 独立的 P2P 身份
- 独立的配置文件

### P2P 网络发现
- 使用 **mDNS** (多播 DNS) 在本地网络中发现节点
- 使用 **libp2p** 协议栈进行通信
- 支持 **WebRTC** 和 **TCP** 传输

### 端口分配
- Web 端口：5173, 5174, 5175...
- P2P 端口：自动分配或使用配置的端口

## 注意事项

1. **资源消耗**：多个客户端会消耗更多 CPU 和内存
2. **网络环境**：确保在同一局域网内测试
3. **防火墙**：可能需要允许应用通过防火墙
4. **数据隔离**：每个客户端的数据是独立的
5. **清理**：测试完成后可以删除 `userData-client-*` 目录

## 清理测试数据

测试完成后，可以删除测试产生的数据：

```bash
# 删除用户数据目录
rmdir /s userData-client-1
rmdir /s userData-client-2
rmdir /s userData-client-3

# 删除环境配置文件 (如果有)
del .env.client-*
```

## 高级配置

### 自定义 P2P 配置
可以通过修改环境变量来自定义 P2P 配置：

```bash
# 自定义 P2P 端口
set VITE_P2P_PORT=4001

# 自定义引导节点
set VITE_P2P_BOOTSTRAP_NODES=/ip4/127.0.0.1/tcp/4001/p2p/QmBootstrapNode
```

### 网络模式
- **本地测试**：在同一台电脑上测试
- **局域网测试**：在同一局域网的不同电脑上测试
- **广域网测试**：通过互联网连接 (需要配置 NAT 穿透)

## 总结

通过多客户端测试，您可以：
- 验证 P2P 网络的连接性
- 测试节点发现机制
- 验证消息传输功能
- 测试群组和联系人功能
- 评估网络性能和稳定性

这是验证 P2P 功能的最有效方法，确保应用在真实的分布式环境中正常工作。