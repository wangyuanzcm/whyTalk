# WhyTalk P2P IM 应用架构分析文档

## 项目概述

WhyTalk 是一个基于 Electron + Vue3 + TypeScript 构建的去中心化 P2P 即时通讯应用。该项目从传统的客户端-服务器架构转型为完全去中心化的 P2P 架构，每个客户端既是用户界面，也是网络服务节点。

## 技术栈

### 核心技术

- **前端框架**: Vue 3 + TypeScript + Vite
- **桌面应用**: Electron
- **UI 组件库**: Naive UI
- **状态管理**: Pinia
- **路由**: Vue Router
- **样式**: Less
- **数据库**: SQLite (better-sqlite3)
- **P2P 网络**: libp2p

### 开发工具

- **构建工具**: electron-vite
- **代码规范**: ESLint + Prettier
- **包管理**: pnpm

## 项目架构

### 整体架构图

```
┌─────────────────────────────────────────────────────────────┐
│                    Electron 应用                            │
├─────────────────────────────────────────────────────────────┤
│  渲染进程 (Renderer Process)                                │
│  ┌─────────────────┐  ┌─────────────────┐  ┌──────────────┐ │
│  │   Vue 3 前端     │  │   P2P 管理界面   │  │   插件系统    │ │
│  │   - 消息界面     │  │   - 节点发现     │  │   - 前端插件  │ │
│  │   - 联系人管理   │  │   - 连接状态     │  │   - WASM插件  │ │
│  │   - 群组管理     │  │   - 网络监控     │  │              │ │
│  └─────────────────┘  └─────────────────┘  └──────────────┘ │
├─────────────────────────────────────────────────────────────┤
│  主进程 (Main Process)                                      │
│  ┌─────────────────┐  ┌─────────────────┐  ┌──────────────┐ │
│  │   服务管理器     │  │   数据库管理     │  │   认证服务    │ │
│  │   - IPC 处理     │  │   - SQLite      │  │   - 用户认证  │ │
│  │   - 任务调度     │  │   - 数据持久化   │  │   - 身份验证  │ │
│  └─────────────────┘  └─────────────────┘  └──────────────┘ │
│  ┌─────────────────┐  ┌─────────────────┐  ┌──────────────┐ │
│  │   P2P 服务      │  │   上传服务       │  │   插件管理    │ │
│  │   - libp2p 节点 │  │   - 文件处理     │  │   - 插件加载  │ │
│  │   - 消息路由     │  │   - 媒体处理     │  │   - API 提供  │ │
│  └─────────────────┘  └─────────────────┘  └──────────────┘ │
├─────────────────────────────────────────────────────────────┤
│  P2P 服务进程 (独立进程)                                     │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │   libp2p 网络节点                                        │ │
│  │   - 节点身份管理                                          │ │
│  │   - 网络发现 (mDNS, Bootstrap)                           │ │
│  │   - 消息传输 (直接消息, 群组消息)                          │ │
│  │   - 连接管理                                             │ │
│  └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

### 目录结构

```
why-talk/
├── src/
│   ├── main/                    # 主进程代码
│   │   ├── index.ts            # 主进程入口
│   │   └── services/           # 服务层
│   │       ├── auth/           # 认证服务
│   │       ├── chat/           # 聊天服务
│   │       ├── database/       # 数据库服务
│   │       ├── ipc/            # IPC 通信
│   │       ├── p2p/            # P2P 客户端服务
│   │       ├── plugin/         # 插件服务
│   │       ├── upload/         # 上传服务
│   │       └── user/           # 用户服务

│   ├── preload/               # 预加载脚本
│   │   └── index.ts
│   └── renderer/              # 渲染进程代码
│       └── src/
│           ├── api/           # API 接口层
│           ├── components/     # Vue 组件
│           ├── hooks/          # 组合式函数
│           ├── layout/         # 布局组件
│           ├── p2p/           # P2P 前端模块
│           ├── router/         # 路由配置
│           ├── services/       # 前端服务层
│           ├── store/          # 状态管理
│           ├── utils/          # 工具函数
│           └── views/          # 页面组件
├── doc/                       # 文档目录
├── scripts/                   # 脚本文件
└── plugins/                   # 插件目录
```

## 核心功能模块

### 1. P2P 网络模块

#### 架构设计

- **独立进程**: P2P 服务运行在独立的 Node.js 进程中
- **IPC 通信**: 通过进程间通信与主进程交互
- **libp2p 框架**: 使用 @chainsafe/libp2p 和 @libp2p/\* 系列包

#### 核心组件

- `src/renderer/src/p2p/P2PConnect.ts`: P2P 连接管理
- `src/renderer/src/utils/p2p-init.ts`: P2P 初始化工具
- `src/renderer/src/services/P2PMessageService.ts`: P2P 消息服务

#### 功能特性

- 节点自动发现 (mDNS, Bootstrap)
- 直接消息传输
- 群组消息广播
- 连接状态监控
- 网络健康检查

### 2. 数据库模块

#### 技术选型

- **数据库**: SQLite
- **驱动**: better-sqlite3
- **特性**: WAL 模式、外键约束、事务支持

#### 数据表设计

- `users`: 用户信息
- `contacts`: 联系人关系
- `contact_groups`: 联系人分组
- `groups`: 群组信息
- `group_members`: 群组成员
- `conversations`: 会话记录
- `messages`: 消息内容
- `message_deletions`: 消息删除记录
- `contact_applications`: 好友申请
- `group_applies`: 群组申请
- `group_notices`: 群组公告
- `p2p_*`: P2P 相关表（节点、身份、消息等）

### 3. 用户界面模块

#### 主要页面

- **消息页面** (`/message`): 聊天界面，支持私聊和群聊
- **联系人页面** (`/contact`): 好友管理、群组管理
- **P2P 管理页面** (`/p2p`): P2P 网络状态监控
- **设置页面** (`/setting`): 应用配置
- **认证页面** (`/auth`): 登录注册

#### 组件架构

- **布局组件**: MainLayout, SubViewLayout
- **业务组件**: 聊天、联系人、群组、用户等
- **基础组件**: Avatar, Loading, Dropdown 等
- **P2P 组件**: P2PStatusIndicator, P2PManager

### 4. 状态管理模块

#### Pinia Store 模块

- `dialogue`: 对话状态
- `talk`: 聊天状态
- `user`: 用户状态
- `p2p`: P2P 网络状态
- `settings`: 应用设置
- `editor`: 编辑器状态
- `uploads`: 上传状态

### 5. 插件系统

#### 插件类型

- **前端插件**: HTML/CSS/JS，运行在独立窗口
- **系统插件**: Rust + WASM，通过 Extism 运行时执行

#### 插件管理

- 插件加载和卸载
- API 权限控制
- 配置管理
- 生命周期管理

## P2P 网络架构

### 网络拓扑

```
节点 A ←→ 节点 B
  ↑         ↓
  ↑         ↓
节点 D ←→ 节点 C
```

### 消息传输流程

1. **直接消息**: 点对点加密传输
2. **群组消息**: 通过 Gossip 协议广播
3. **文件传输**: 分块传输，支持断点续传
4. **状态同步**: 定期同步联系人和消息状态

### 身份认证

- **公私钥对**: 应用启动时自动生成
- **数字签名**: 每条消息都包含发送者签名
- **身份验证**: 通过公钥验证消息真实性

## 安全机制

### 加密传输

- **传输层加密**: libp2p Noise 协议
- **端到端加密**: 消息内容加密
- **数字签名**: 防止消息篡改

### 隐私保护

- **本地存储**: 所有数据存储在本地
- **去中心化**: 无中央服务器收集数据
- **匿名通信**: 支持匿名身份

## 开发和部署

### 开发环境

```bash
# 安装依赖
pnpm install

# 开发模式
pnpm dev

# 构建应用
pnpm build:win  # Windows
pnpm build:mac  # macOS
pnpm build:linux # Linux
```

### 测试脚本

- `scripts/start-multiple-clients.*`: 启动多客户端测试
- `scripts/test-p2p.js`: P2P 功能测试
- `scripts/create-test-user.js`: 创建测试用户

## 技术特色

### 1. 去中心化架构

- 无需中央服务器
- 每个客户端即是服务节点
- 数据完全本地化

### 2. 现代化技术栈

- Vue 3 Composition API
- TypeScript 类型安全
- Electron 跨平台支持
- libp2p 成熟的 P2P 框架

### 3. 可扩展性

- 插件系统支持功能扩展
- 模块化架构便于维护
- 标准化的 API 接口

### 4. 用户体验

- 现代化 UI 设计
- 响应式布局
- 实时状态更新
- 离线消息支持

## 未来发展方向

### 短期目标

- 完善 P2P 网络稳定性
- 优化消息传输性能
- 增强安全机制
- 完善插件生态

### 长期规划

- 支持更多平台（移动端）
- 集成区块链技术
- 支持加密货币支付
- 构建去中心化社交网络

## 总结

WhyTalk 代表了即时通讯应用的新方向，通过 P2P 技术实现了真正的去中心化通信。项目架构清晰，技术选型合理，具有良好的可扩展性和维护性。随着 P2P 技术的不断成熟，该项目有望成为去中心化通信领域的重要参考实现。
